<html>

<head>
  <script src="https://aframe.io/releases/0.8.2/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-fps-look-controls-component/dist/aframe-fps-look-controls-component.min.js"></script>
  <script src="https://rawgit.com/feiss/aframe-environment-component/master/dist/aframe-environment-component.min.js"></script>
</head>

<body>
  <a-scene stats>
    <a-assets>
      <a-asset-item id="obj" src="models/test.obj"></a-asset-item>
      <a-asset-item id="mtl" src="models/test.mtl"></a-asset-item>
      <a-asset-item id="kobj" src="models/KUS.obj">  </a-asset-item>
      <a-asset-item id="kmtl" src="models/KUS.mtl"></a-asset-item>
    </a-assets>
    <a-entity id="tch">
      <a-box position='4 1 -4' rotation='0 315 0' color='grey' scale='1 0.5 0.5'>
        <a-text id="timer" align='center' position="0 0 0.6" value='Time: 15'></a-text>
      </a-box>
      <a-box position='-4 1 -4' rotation='0 45 0' color='grey' scale='1 0.5 0.5'>
        <a-text id="score" align='center' position="0 0 0.6" value='Score: 0'></a-text>
      </a-box>
      <a-box id='playerbutton' position='0 2 -4' color='grey' scale='1 0.5 0.5'>
        <a-text value='Start' align='center' position='0 0 0.6'></a-text>
      </a-box>
      <a-entity obj-model="obj: #obj;mtl: #mtl" scale="4 3 4" rotation='0 90 0'></a-entity>
      <a-entity state="down" id="target" obj-model="obj: #kobj;mtl: #kmtl" rotation='-90 0 0' scale="1 1 1" position='0 -0.23 -17.2'>
        <a-animation attribur='rotation' begin='down' to='-90 0 0' from="0 0 0"></a-animation>
        <a-animation attribur='rotation' begin='up' to='0 0 0' from="-90 0 0"></a-animation>
      </a-entity>
      <a-entity state="down" id="target" obj-model="obj: #kobj;mtl: #kmtl" rotation='-90 0 0' scale="1 1 1" position='-10.3 0.21 -15.6'>
        <a-animation attribur='rotation' begin='down' to='-90 0 0' from="0 0 0"></a-animation>
        <a-animation attribur='rotation' begin='up' to='0 0 0' from="-90 0 0"></a-animation>
      </a-entity>
      <a-entity state="down" id="target" obj-model="obj: #kobj;mtl: #kmtl" rotation='-90 0 0' scale="1 1 1" position='17.48 1.66 -25.5'>
        <a-animation attribur='rotation' begin='down' to='-90 0 0' from="0 0 0"></a-animation>
        <a-animation attribur='rotation' begin='up' to='0 0 0' from="-90 0 0"></a-animation>
      </a-entity>
      <a-entity state="down" id="target" obj-model="obj: #kobj;mtl: #kmtl" rotation='-90 0 0' scale="1 1 1" position='-8.6 0.6 -32.4'>
        <a-animation attribur='rotation' begin='down' to='-90 0 0' from="0 0 0"></a-animation>
        <a-animation attribur='rotation' begin='up' to='0 0 0' from="-90 0 0"></a-animation>
      </a-entity>
      <a-entity state="down" id="target" obj-model="obj: #kobj;mtl: #kmtl" rotation='-90 0 0' scale="1 1 1" position='-21.8 0.49 -28.2'>
        <a-animation attribur='rotation' begin='down' to='-90 0 0' from="0 0 0"></a-animation>
        <a-animation attribur='rotation' begin='up' to='0 0 0' from="-90 0 0"></a-animation>
      </a-entity>
      <a-entity state="down" id="target" obj-model="obj: #kobj;mtl: #kmtl" rotation='-90 0 0' scale="1 1 1" position='6.96 1 -34.3'>
        <a-animation attribur='rotation' begin='down' to='-90 0 0' from="0 0 0"></a-animation>
        <a-animation attribur='rotation' begin='up' to='0 0 0' from="-90 0 0"></a-animation>
      </a-entity>
      <a-entity id="shsshs" environment="lightPosition: 30 20 -30;skyType:gradient; skyColor:#a7f0ff;flatShading:true; shadow:true;playArea:false;lighting:distant;fog:0"></a-entity>
      <a-entity>
      </a-entity>
    </a-entity>
    <a-entity position="0 0 0">
      <a-camera collision id="cam" wasd-controls-enabled="true" fps-look-controls="user-height: 0" look-controls-enabled="false">
        <a-light id="artem" type="point" position="0.3 -0.38 -1.72" color="yellow" distance=10> </a-light>
        <a-cursor></a-cursor>
      </a-camera>
      <a-cylinder follower id="gun" follower position="0 1 0" color="#ff0000" radius="0.09" height="3.5" rotation="90 0 0"></a-cylinder>
    </a-entity>
    <script> 
      AFRAME.registerComponent('follower', {
        tick: function () {
          gun.object3D.position.x = cam.object3D.position.x + Math.cos(cam.object3D.rotation.y) * 0.5;
          gun.object3D.position.z = cam.object3D.position.z - Math.sin(cam.object3D.rotation.y + Math.PI / 40) * 0.5;
          gun.object3D.position.y = 1;
          gun.object3D.rotation.x = cam.object3D.rotation.x + Math.PI / 1.90;
          gun.object3D.rotation.y = cam.object3D.rotation.y + Math.PI / 45;
          gun.object3D.rotation.z = cam.object3D.rotation.z;
        }
      });
      AFRAME.registerComponent('collision', {
        tick: function () {
          var divs = document.querySelectorAll('#shooot'), i;
          var decoys = document.querySelectorAll('#target'), j;
          for (j = 0; j < decoys.length; ++j)
            for (i = 0; i < divs.length; ++i) {
              if ((divs[i].object3D.position.x - divs[i].getAttribute('radius') <= decoys[j].object3D.position.x + 1 && divs[i].object3D.position.x + parseInt(divs[i].getAttribute('radius')) >= decoys[j].object3D.position.x - 1) &&
                (divs[i].object3D.position.y - divs[i].getAttribute('radius') <= decoys[j].object3D.position.y + 2 && divs[i].object3D.position.y + parseInt(divs[i].getAttribute('radius')) >= decoys[j].object3D.position.y) &&
                (divs[i].object3D.position.z - divs[i].getAttribute('radius') <= decoys[j].object3D.position.z + 1 && divs[i].object3D.position.z + parseInt(divs[i].getAttribute('radius')) >= decoys[j].object3D.position.z - 1)) {
                if (decoys[j].getAttribute('state') == 'up') {
                  cam.sceneEl.removeChild(divs[i]);
                  decoys[j].setAttribute('state', 'down')
                  decoys[j].emit('down');
                  score += 1
                  setTimeout(function call() {
                    worker = decoys[Math.floor(Math.random() * (5 - 0 + 1)) + 0]
                    if (worker.getAttribute('state') == 'down') {
                      worker.emit('up')
                      setTimeout(function (kuss) { kuss.setAttribute('state', 'up') }, 1000, worker)
                    }
                    if (worker.getAttribute('state') == 'up')
                      call()
                  }, 2000)
                  document.querySelector('#score').setAttribute('value', 'Score: ' + score);
                }
              }

            }
        }
      }); 
    </script>
    <script>
      function destr(idd) {
        cam.sceneEl.removeChild(idd);
      }
      var frame = document.querySelector('#tch');
      artem.setAttribute('intensity', 0);
      frame.addEventListener('click', function () {
        artem.setAttribute('intensity', 0.2);
        var shoot = document.createElement('a-sphere');
        shoot.setAttribute('id', "shooot");
        shoot.setAttribute('color', "yellow");
        shoot.setAttribute('radius', "0.09");
        cam.sceneEl.appendChild(shoot);
        var kus = document.createElement('a-animation')
        kus.setAttribute('attribute', 'position')
        kus.setAttribute('dur', '300')
        kus.setAttribute('fill', 'forwards')
        kus.setAttribute('easing', 'linear')
        kus.setAttribute('to', (cam.object3D.position.x - Math.sin(cam.object3D.rotation.y) * 40 * Math.cos(cam.object3D.rotation.x)).toString() + ' ' + (cam.object3D.position.y + Math.sin(cam.object3D.rotation.x) * 40).toString() + ' ' + (cam.object3D.position.z - Math.cos(cam.object3D.rotation.y) * 40 * Math.cos(cam.object3D.rotation.x)).toString())
        shoot.appendChild(kus);
        shoot.setAttribute('position', document.querySelector('#gun').getAttribute('position'))
        setTimeout(destr, 300, shoot);
        setTimeout(function () { artem.setAttribute('intensity', 0); }, 100)
      });
    </script>
    <script>
      var decoys = document.querySelectorAll('#target'), j;
      for (j = 0; j < decoys.length; ++j)
        decoys[j].setAttribute('state', 'down')
      function call() {
        worker = decoys[Math.floor(Math.random() * (5 - 0 + 1)) + 0]
        if (worker.getAttribute('state') == 'down') {
          worker.emit('up')
          setTimeout(function (kuss) { kuss.setAttribute('state', 'up') }, 1000, worker)
        }
        if (worker.getAttribute('state') == 'up')
          call()
      }
      let time = 15;
      let score = 0;
      let unt = true
      let but = document.querySelector('#playerbutton')
      but.addEventListener('click', function (event) {
        if (unt) {
          call();
          setTimeout(call, 1000);
          setTimeout(call, 5000);
          setTimeout(call, 10000);
          console.log('start timer')
          unt = false;
          let score = 0;
          but.setAttribute('visible', 'false')
          setTimeout(countdown_timer, 1);
        }

      })
      function countdown_timer() {
        time--;
        if (time > 0) {
          setTimeout(countdown_timer, 1000);
        }
        else {
          var decoys = document.querySelectorAll('#target'), j;
          for (j = 0; j < decoys.length; ++j) {
            decoys[j].setAttribute('state', 'off')
          }
        }
        document.querySelector('#timer').setAttribute('value', 'Time: ' + time);
      }
    </script>
  </a-scene>
  </script>
</body>

</html>